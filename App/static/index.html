<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='x-ua-compatible' content='ie=edge'>
  <title>Mapzen</title>
  <meta name='description' content=''>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css'>
<!--   <link rel='stylesheet' href='../assets/listnav.css'> -->
  <link rel='stylesheet' href='https://mapzen.com/common/styleguide/styles/styleguide.css'>
  <link rel='shortcut icon' href='/resources/favicon.ico'>
  <style>
  	body.data-pages #extracts li{margin-top:-50px;padding-top:60px}h5.place_name{position:relative}body.data-pages h5.place_name{text-transform:none}
    
    #search-box{z-index:50; margin: 20px 0 40px;}

    h1{text-transform:lowercase}
    .data-filter-label{position:relative;font-size:12px;line-height:1;font-weight:bold;color:#000;text-transform:uppercase}body.data-pages .loading{color:#d4645c;text-align:center}body.data-pages .updated-at{color:#d4645c;font-size:85%}body.data-pages #extracts ul{padding-left:0}body.data-pages #extracts li{text-align:left;list-style-type:none}body.data-pages #extracts a:hover{color:#d4645c}body.data-pages #extracts .btn{color:#6ea0a4;font-weight:500;background:white;font-size:12px;white-space:normal}body.data-pages #extracts .btn:not(:last-of-type){border-right:0}body.data-pages #extracts .btn:hover{background-color:whitesmoke;border-color:#ccc}body.data-pages #extracts .btn.ln-selected{background-color:whitesmoke;color:#d4645c}body.data-pages #extracts .btn-default:focus{border-color:#ccc !important}body.data-pages #extracts_list .btn{padding-left:4px;padding-right:4px}body.data-pages #extracts_list .size{display:block;font-size:10px;color:gray}@media (max-width: 991px){body.data-pages #extracts_list .btn-group-justified{position:relative;display:inline-block;vertical-align:middle}body.data-pages #extracts_list .btn-group-justified>.btn:first-child:not(:last-child){border-top-right-radius:4px;border-bottom-right-radius:0;border-bottom-left-radius:0}body.data-pages #extracts_list .btn-group-justified>.btn,body.data-pages #extracts_list .btn-group-justified>.btn-group,body.data-pages #extracts_list .btn-group-justified>.btn-group>.btn{display:block;float:none;width:100%;max-width:100%}body.data-pages #extracts_list .btn-group-justified>.btn{position:relative;float:left}body.data-pages #extracts_list .btn-group-justified>.btn:not(:last-of-type){border-right:1px solid #ccc;border-bottom:0}body.data-pages #extracts_list .btn-group-justified>.btn+.btn{margin-left:0}body.data-pages #extracts_list .btn-group-justified>.btn:last-of-type{border-bottom-left-radius:4px;border-top-right-radius:0}}body.data-pages #extracts_list-nav{padding-top:0 !important;margin-left:0 !important}body.data-pages #extracts_list-nav .btn{padding-left:2px;padding-right:2px;line-height:2}body.data-pages #extracts_list-nav::before{content:'Filter by first letter';position:relative;font-size:11px;line-height:1;font-weight:bold;color:#aaa;text-transform:uppercase}body.data-pages #extracts_list-nav .ln-letter-count{text-align:center;font-size:0.8em;line-height:1;margin-bottom:3px;color:white;background-color:rgba(0,0,0,0.75);padding:4px 6px;border-radius:3px;z-index:200}body.data-pages .ln-letters>.ln-disabled,body.data-pages .ln-letters>.ln-disabled:hover,body.data-pages .ln-letters>.ln-disabled:focus,body.data-pages .ln-letters>.ln-disabled:active,body.data-pages .ln-letters>.ln-disabled:visited{color:#ccc !important;border-color:#ccc !important;cursor:default}body.data-pages .ln-letters>.ln-disabled:not(.ln-selected),body.data-pages .ln-letters>.ln-disabled:hover:not(.ln-selected),body.data-pages .ln-letters>.ln-disabled:focus:not(.ln-selected),body.data-pages .ln-letters>.ln-disabled:active:not(.ln-selected),body.data-pages .ln-letters>.ln-disabled:visited:not(.ln-selected){background:white !important}body.data-pages .ln-letters>.ln-disabled:focus,body.data-pages .ln-letters>.ln-disabled:active{box-shadow:0 1px 1px rgba(0,0,0,0.075) !important}body.data-pages h5.place_name{display:block;font-family:"Open Sans", sans-serif;font-size:22px;font-weight:400;line-height:1;text-transform:capitalize;color:#494949}

    body.data-pages #search_input{height:41px}
    body.data-pages .inline-submit .btn { background: #666; color: white;}
    body.data-pages .inline-submit .btn:hover { background: #555; }

    body.data-pages #search_box::before{content:'Filter by city or region name';position:relative;font-size:11px;line-height:1;font-weight:bold;color:#000;text-transform:uppercase}body.data-pages #borders-search_box::before{content:'Filter by country or region name';position:relative;font-size:11px;line-height:1;font-weight:bold;color:#aaa;text-transform:uppercase}body.data-pages .leaflet-popup-content{text-transform:capitalize}

      body.data-pages {
        margin-top: 0;
      }
      #map {
        border-right: 1px solid rgb(224,224,224);
      }
      #map path {
        fill: #d4645c;
        stroke: #d4645c;
        stroke-width: 2;
        stroke-opacity: .3;
        fill-opacity: .3;
      }
      #map path.blue {
        fill: #6ea0a4;
        stroke: #6ea0a4;
      }
      #map path.outline {
        stroke: #000;
        fill: transparent;
      }
      .drag-icon {
        width: 10px;
        height: 10px;
        background: #000;
        border-radius: 10px;
        cursor: pointer;
      }
      .leaflet-container a {
        color: #6ea0a4;
      }
      .leaflet-container .leaflet-control-zoom-in,
      .leaflet-container .leaflet-control-zoom-out {
        color: #000;
      }
      .country {
        border-top: 1px solid rgb(224,224,224);
        margin-top: 20px;
      }
      .country-name {
        background: rgb(224,224,224);
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 1px;
        padding: 2px 10px;
        font-size: 12px;
        cursor: pointer;
        float: left;
      }
      .country-name:hover {
        background: #ccc;
      }
      .city {
        text-transform: capitalize;
        margin: 3px 0 3px 10px;
        cursor: pointer;
        clear: both;
        color: #000;
        font-weight: normal;
        display: block;
      }
      .city:hover {
        text-decoration: underline;
      }
      #make-request {
        display: none;
        background: rgba(110,160,164,.3);
        padding: 20px;
      }
      #make-request .btn {
        margin-bottom: 20px;
      }
      #make-request .btn:hover {
        background: rgba(110,160,164,.4);
      }
      #request {
        background: rgb(224,224,224);
        margin: 50px 0;
        padding: 20px;
      }
      .autocomplete {
        border: 1px solid #ddd;
      }
      .suggestion {
        border-bottom: 1px solid #ddd;
        padding: 1px 0 1px 15px;
        color: #808080;
        cursor: pointer;
      }
      .suggestion.selected {
        color: #000;
        background: #ddd;
      }
      .suggestion:hover {
        color: #000;
        background: #eee;
      }
      .suggestion:last-child {
        margin-bottom: -1px;
      }
  </style>
</head>
<body class='data-pages'>

  <div class='container'>
<!--     <div class='row headroom-large'>
      <div class='col-md-8 col-md-offset-2 text-center'>
        <a class='btn btn-default btn-transparent' href='/data'><i class='fa fa-angle-left'></i>&nbsp;&nbsp; data</a>
      </div>
    </div> -->
    
  </div>

  <div class='container-fluid'>
    <div class='col-xs-6' style='position: fixed;'>
      <div id='map'></div>
    </div>
    <div class='col-xs-6' style='float: right;'>
      <div class='row headroom'>
      <div class='col-xs-12 text-center'>
        <h1>Metro Extracts</h1>
      </div>
    </div>
    <div class='row'>
      <div class='col-xs-12'>

          <p>
        Now itâ€™s even easier to get local data so you can start building cool stuff. Each week, we automatically extract the latest <a href='http://openstreetmap.org/'>OpenStreetMap</a> data into manageable, metro-area shapefiles in a variety of formats for you to use.
      </p>
      <p>
        <a>Format Guide</a> | <a>Documentation</a> | <a>Tutorial</a> | <a>Request an Extract</a>
      </p>

<!--         <div class='updated-at headroom' id='last_updated_at'>
          Last updated on <span class='datetime'>{{ dateRefreshed }} at {{ timeRefreshed }} UTC</span>
        </div> -->
      </div>
    </div>
      <div class='row inline-submit' id='search-box'>
        <label class='data-filter-label' for='search_input'>Filter Extracts by City or Region</label>
        <input type='search' class='hasclear col-sm-9 col-xs-8' id='search_input' placeholder='example: Los Angeles' type='text'>
        <input id='search_submit' type="submit" value="search" class="col-xs-4 col-sm-3 btn btn-transparent">
        <div class="autocomplete"></div>
      </div>
      <div id="make-request">
        <p>Hmm, we don't have an extract for <span class="name"></span> yet. Would you like to request one?</p>
        <a class="btn btn-transparent" target="_blank">Create <span class="name"></span> Request</a>
        <p>Otherwise, would one of these work?</p>
      </div>
      <div id='extracts'></div>
      <div class='row' id='request'>
        <p>Can't find what you're looking for? Request one!</p>
        <div class='btn btn-transparent'>Submit GH Issue</div>
      </div>
    </div>
  </div>

<!--   <script src='https://mapzen.com/common/styleguide/scripts/mapzen-styleguide.min.js'></script> -->
  <script src='https://code.jquery.com/jquery-2.2.0.min.js'></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<!--   <script src='../assets/jquery.fastLiveFilter.js'></script>
  <script src='../assets/jquery-listnav.min.js'></script> -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js'></script>
  <script src='https://mapzen.com/tangram/0.5/tangram.min.js'></script>
  <script type="text/javascript">

    d3.select("#map").style("height", window.innerHeight + 'px');

    function hasWebGL () {
      try {
        var canvas = document.createElement('canvas')
        return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')))
      } catch (x) {
        return false
      }
    }

    var extractLayers = [];
    function initDisplayMap (geoJSONUrl, geoJSONOptions) {
      var southwest = L.latLng(0, -125)
      var northeast = L.latLng(0, 125)
      var options = {
        scrollWheelZoom: false,
        // Disables dragging on touch-detected devices
        dragging: (window.self !== window.top && L.Browser.touch) ? false : true,
        tap: (window.self !== window.top && L.Browser.touch) ? false : true,
      }
      var displayMap = L.map('map', options).fitBounds(L.latLngBounds(southwest, northeast))
      var layer

      if (hasWebGL() === true) {
        layer = Tangram.leafletLayer({
          scene: './scene.yaml',
          attribution: '<a href="https://mapzen.com/tangram">Tangram</a> | &copy; OSM contributors | <a href="https://mapzen.com/">Mapzen</a>'
        })
      } else {
        layer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
          attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
        })
      }
      layer.addTo(displayMap)

      $.ajax({
        type: 'GET',
        url: geoJSONUrl,
        dataType: 'json',
        success: function (data) {
          L.geoJson(data, geoJSONOptions).addTo(displayMap);
        },
        error: function (request, status, error) {
          // do nothing
        }
      })

      return displayMap
    }
    var mapurl = 'https://s3.amazonaws.com/metro-extracts.mapzen.com/cities.geojson'

    var getNormalizedId = function (name) {
      return name.toLowerCase().replace(/,?\s+/g, '-').replace(/_/g, '-')
    }

    var onEachFeature = function (feature, layer) {
      extractLayers.push(layer);
      if (feature.properties && feature.properties.name) {
        var text = feature.properties.name;
        layer.on('click', function (e) {
          var str = text.split("_")[0].replace(/-/g," ");
          document.getElementById("search_input").value = str.capitalize();
          filterList(str);
        })
      }
    }

    // Setup map
    var geoJSONOptions = {
      onEachFeature: onEachFeature
    }
    var displayMap = initDisplayMap(mapurl, geoJSONOptions)

    var nestedCities;

    d3.json('./cities.json',function(data) {
      var cityArray = [];
      for (region in data.regions){
        for (city in data.regions[region].cities) {
          var cityCountry = city.split("_");
          cityArray.push({
            city: cityCountry[0],
            country: cityCountry[1],
            bbox: data.regions[region].cities[city].bbox
          });
        }
      }
      nestedCities = d3.nest()
        .key(function(d){ return d.country; })
        .entries(cityArray)
        .sort(function(a,b){ return (a.key < b.key) ? -1 : (a.key > b.key) ? 1 : 0; });

      console.log(nestedCities);
      drawList(nestedCities);
    });

    function drawList(data) {
      var countries = d3.select("#extracts").selectAll(".country").data(data);
      var enterCountries = countries.enter().append("div").attr("class","country");
      countries.exit().remove();
      enterCountries.append("div").attr("class","country-name")
        .on("click",function(d){
          doSearch(d.key);
        });
      countries.select(".country-name").text(function(d){ return d.key; });
      var cities = countries.selectAll(".city").data(function(d){ return d.values; });
      cities.enter().append("a").attr("class","city");
      cities.text(function(d){ return d.city.replace(/-/g," "); })
        .attr("href",function(d){ return "./city.html#"+d.city; });
      cities.exit().remove();
    }

    d3.select("#search_submit").on("click",function(){
      doSearch(document.getElementById("search_input").value);
    });
    
    var wait = false,
      waitQuery;

    function suggestSearch(query) {
      if (!wait) {
        wait = true;
        doSuggestion(query);
        setTimeout(function(){ wait = false; }, 500);
      } else {
        waitQuery = query;
      }
    }

    function doSuggestion(query) {
      d3.json("https://search.mapzen.com/v1/autocomplete?text="+query+"&sources=wof&api_key=search-owZDPeC", function(error, json) {
          var suggestion = d3.select(".autocomplete")
            .selectAll(".suggestion").data(json.features);
          suggestion.enter().append("div").attr("class","suggestion");
          suggestion.exit().remove();
          suggestion.text(function(d){ return d.properties.label; })
            .on("click",function(d){
              document.getElementById("search_input").value = d.properties.label;
              doSearch(d.properties.label);
              filterList(d.properties.label);
            });
      });
    }

    function doSearch(query) {
      d3.selectAll(".suggestion").remove();
      
      d3.json("https://search.mapzen.com/v1/search?text="+query+"&sources=wof&api_key=search-owZDPeC", function(error, json) {
          var bbox = json.features[0].bbox;
          displayMap.fitBounds([[bbox[1],bbox[0]],[bbox[3], bbox[2]]]);

          if (json.features[0].properties.layer == "locality") displayMap.zoomOut(2);
          if (d3.selectAll(".city")[0].length == 0){
            requestExtract(json.features[0]);
          } else {
            clearRequest();
          }
      });
    }

    Number.prototype.toRad = function() {
       return this * Math.PI / 180;
    }
    Number.prototype.toDeg = function() {
       return this * 180 / Math.PI;
    }

    function calculateOffset(theta, d, lat1, lng1) {
      var lat1 = lat1.toRad(), 
        lng1 = lng1.toRad(),
        R = 6371;

      var lat2 = Math.asin( Math.sin(lat1)*Math.cos(d/R) 
            + Math.cos(lat1)*Math.sin(d/R)*Math.cos(theta) ),
        lng2 = lng1 + Math.atan2(Math.sin(theta)*Math.sin(d/R)*Math.cos(lat1), 
              Math.cos(d/R)-Math.sin(lat1)*Math.sin(lat2));

      return [lat2.toDeg(), lng2.toDeg()];
    }

    function calculateNewBox(bbox) {
      var distance = Math.sqrt(Math.pow(bbox[3]-bbox[1],2) + Math.pow(bbox[2]-bbox[0], 2))*25;
      var northEast = calculateOffset(-Math.PI*3/4, distance, bbox[1], bbox[0]),
      southWest = calculateOffset(Math.PI/4, distance, bbox[3], bbox[2]);
      return [northEast, southWest];
    }

    var rect, 
      dots = [],
      outline,
      requestBoundingBox;
    var myIcon = L.divIcon({className: 'drag-icon'});
    //var wof = "http://whosonfirst.mapzen.com/spelunker/id/";
    var wof = "/wof/";

    function requestExtract(metro) {
      var geoID = metro.properties.id;
      requestBoundingBox = calculateNewBox(metro.bbox);

      drawRequestBox();

      d3.json(wof+geoID+".geojson",function(data){
        var outline = L.geoJson(data.geometry, { className : "outline" }).addTo(displayMap);
        displayMap.addLayer(outline);
      });

      var bbox = metro.bbox,
        p1 = L.latLng(bbox[1],bbox[0]),
        p2 = L.latLng(bbox[3],bbox[2]),
        p3 = L.latLng(bbox[1],bbox[2]),
        p4 = L.latLng(bbox[3],bbox[0]);

      var nearby = [{
        key : "Nearby Cities",
        values : []
      }];

      extractLayers.forEach(function(l){
        if (l.getBounds().contains(p1) || l.getBounds().contains(p2) || l.getBounds().contains(p3) || l.getBounds().contains(p4)) 
          nearby[0].values.push({
            city : l.feature.properties.name.split("_")[0],
            country : l.feature.properties.name.split("_")[1],
            bbox : l.feature.bbox
          })
      });
      console.log(nearby)
      drawList(nearby);

      d3.select("#make-request").style("display","block")
        .selectAll(".name").text(metro.properties.name);
      d3.select("#request").style("display","none");
      d3.select("#make-request").select("a")
        .on("click",function(){
          d3.select(this).attr("href","https://github.com/mapzen/data-pages/issues/new?title="+metro.properties.name+"&body=Bounding Box: "+requestBoundingBox);
        });
    }
    function drawRequestBox() {
      clearMap();
      rect = new L.Rectangle(new L.LatLngBounds(requestBoundingBox), { className : "blue" });
      displayMap.addLayer(rect);

      var cSW = new L.marker(requestBoundingBox[0], { icon : myIcon, draggable: true });
      dots.push(cSW);
      var cNE = new L.marker(requestBoundingBox[1], { icon : myIcon, draggable: true });
      dots.push(cNE);

      cSW.on("drag",function(e){
        requestBoundingBox[0] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
        displayMap.removeLayer(rect);
        rect = new L.Rectangle(new L.LatLngBounds(requestBoundingBox), { className : "blue" });
        displayMap.addLayer(rect);
      });
      cNE.on("drag",function(e){
        requestBoundingBox[1] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
        displayMap.removeLayer(rect);
        rect = new L.Rectangle(new L.LatLngBounds(requestBoundingBox), { className : "blue" });
        displayMap.addLayer(rect);
      });

      dots.forEach(function(l){
        displayMap.addLayer(l);
      });
    }
    function clearMap() {
      if (rect) displayMap.removeLayer(rect);
      if (outline) displayMap.removeLayer(outline);
      dots.forEach(function(l){
        displayMap.removeLayer(l);
      });
      dots = [];
    }
    function clearRequest() {
      clearMap();
      d3.select("#request").style("display","block");
      d3.select("#make-request").style("display","none");
    }

    var keyIndex = -1;

    String.prototype.capitalize = function() {
      var words = this.split(" "),
        capitalized = words.map(function(w){ return w.charAt(0).toUpperCase() + w.slice(1); });
      return capitalized.join(" ");
    }

    d3.select("#search_input").on("keyup",function(d, i, e){
      var inputDiv = document.getElementById("search_input");
      var val = inputDiv.value;

      if (!val.length) {
        drawList(nestedCities);
        d3.selectAll(".suggestion").remove();
        clearRequest();
        return;
      }

      var currentList = d3.selectAll(".suggestion");
      if (event.keyCode == 40) {
        keyIndex = Math.min(keyIndex+1, currentList[0].length-1);
        currentList.each(function(d, i){ //arrow down
          if (i == keyIndex)
            inputDiv.value = d.properties.label;
        }).classed("selected",function(d,i){ return i == keyIndex; });
        
      } else if (event.keyCode == 38) { //arrow up
        keyIndex = Math.max(keyIndex-1, 0);
        currentList.each(function(d, i){
          if (i == keyIndex)
            inputDiv.value = d.properties.label;
        }).classed("selected",function(d,i){ return i == keyIndex; });
        
      } else if (event.keyCode == 13) {
        keyIndex = -1;
        filterList(val);
        d3.selectAll(".suggestion").remove();
        doSearch(val);
      } else if (event.keyCode < 48 || event.keyCode > 90) {
        return; //restrict autocomplete to 0-9,a-z character input
      } else {
        keyIndex = -1;
        suggestSearch(val);
        filterList(val);
      }
    });

    function filterList(str) {
      var newData = [];
      nestedCities.forEach(function(d){
        var country = jQuery.extend({}, d);
        if (country.key.replace(/-/g," ").indexOf(str) != -1) {
          newData.push(country);
        } else {
          country.values = country.values.filter(function(e){ 
            return e.city.replace(/-/g," ").indexOf(str) != -1; 
          });
          if (country.values.length) newData.push(country);
        }
      });
      drawList(newData);
    }
  </script>
</body>
</html>