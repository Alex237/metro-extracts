{% extends "layout.html" %}

{% block styles %}
  <link rel='stylesheet' href='{{ url_for('static', filename='css/metros.css') }}'>
{% endblock %}

{% block content %}
  <div class='col-xs-12 col-sm-6 map-wrapper'>
    <div id='map'></div>
  </div>
  <div class='col-xs-12 col-sm-6'>
    <h1 class="headroom text-center">metro extracts</h1>
    <p>Each week, Metro Extracts automatically extracts the latest <a href='http://openstreetmap.org/'>OpenStreetMap</a> data into manageable, metro-area files in a variety of formats for you to use. Download an existing extracts to get started right away, or request a new extract of anywhere in the world!</p>
    <p>The <span class="legend-red">red</span> boxes represent existing extracts, while the <span class="legend-blue">blue</span> ones are new requests.</p>
    <p style="margin-top: 20px;">
      <a href="https://mapzen.com/documentation/metro-extracts/">Documentation</a> |
      <a href="https://mapzen.com/documentation/metro-extracts/walkthrough/">Tutorial</a> |
      <a href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">File Format Guide</a>
    </p>
    <div class='row inline-submit' id='search-box'>
      <label class='data-filter-label' for='search_input'>Search for a City or Region</label>
      <input type='search' class='hasclear col-sm-9 col-xs-8' id='search_input' placeholder='example: Los Angeles' type='text'>
      <input id='search_submit' type="submit" value="search" class="col-xs-4 col-sm-3 btn btn-transparent">
      <div class="autocomplete"></div>
    </div>
    <div id="request-wrapper">
      <p id="search-error" class="request-messaging">Sorry, we don't have any results for <span class="name"></span>. Try a different search?</p>
      <p class="encompassed-text request-messaging">Your extract is included inside of a larger area: </p>
      <div id="extracts">
        {% for country_metros in metros_tree %}
          <div class="country">
            <div class="country-name">{{ country_metros.country }}</div>
            {% for metro in country_metros.metros %}
              <a class="city" href="{{ metro.href }}">{{ metro.name }}</a>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
      <div id="make-request">
        <p class="default-request-text request-messaging">Hmm, we don't have an extract for <span class="name"></span> yet. Would you like to request one?</p>
        <p class="encompassed-text request-messaging">If you'd like to request an extract specifically for <span class="name"></span>, click the button below. Please note, this can take a few hours to process.</p>
        <p class="request-greater-1 request-messaging">We don't have a request for <span class="name"></span> yet, but you can request one by clicking the button below. Please note, you have requested a large area and this request will take more than a few hours to process.</p>
        <p class="request-greater-1 encompassed-text default-request-text request-messaging">Feel free to drag the corners of the box on the map to adjust the size of your request.</p>
        <p class="request-greater-5 request-messaging">Sorry, but your request for <span class="name"></span> is too large to prcoess. Please make your request a smaller area.</p>
        <form action="{{ url_for('ODES.post_envelope') }}" method="post">
          <input name="bbox_n" type="hidden" />
          <input name="bbox_w" type="hidden" />
          <input name="bbox_s" type="hidden" />
          <input name="bbox_e" type="hidden" />
          <input name="wof_id" type="hidden" />
          <input name="wof_name" type="hidden" />
          <button class="btn btn-transparent">Create <span class="name"></span> Request</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src='{{ url_for('static', filename='js/metros.js') }}'></script>
{% endblock %}

{% block script %}
  var mapHeight = window.innerWidth < 768 ? 300 : window.innerHeight - 56;
  d3.select("#map").style("height", mapHeight + 'px');
  
  var metrosPage = Metros().init(
    {{metros_tree|tojson|safe}}, 
    "{{ url_for('Metro-Extracts.get_cities_geojson') }}", 
    "{{ url_for('static', filename='scene.yaml') }}"
  );

  if (document.getElementById("search_input").value.length)
    metrosPage.onSubmit(document.getElementById("search_input").value);

  d3.selectAll(".country-name")
    .on("click",function(d){
      metrosPage.doSearch(d3.select(this).text(), true);
    });

  d3.select("#search_submit").on("click",function(){
    var val = document.getElementById("search_input").value;
    if (val.length)
      metrosPage.onSubmit(val);
  });

  d3.select("#search_input").on("keyup",function(){
    metrosPage.processKeyup(d3.event);
  });
  
{% endblock %}