{% extends "layout.html" %}

{% block styles %}
  <link rel='stylesheet' href='{{ url_for('static', filename='css/metro.css') }}'>
{% endblock %}

{% block content %}
  <div class="col-xs-12">
    {% include "odes/logout-fragment.html" %}
    <ol class="breadcrumb">
      <li>
        <a href="{{ url_for('Metro-Extracts.index') }}">Metro Extracts</a>
      </li>
      <li>
        <a href="{{ url_for('ODES.get_extracts') }}">Your Extracts</a>
      </li>
      <li class="active">{{extract.wof.name or extract.id or extract.odes.id}}</li>
    </ol>
  </div>
  <div class="col-sm-6 col-xs-12">
    <div id="map"></div>
  </div>
  <div class="col-sm-6 col-xs-12">
    <h2>Your Extract:</h2>
    <h2>{{extract.wof.name or extract.id or extract.odes.id}}</h2>
    <div class="btn-group" style="margin: 0 auto;">
      {% if user_id %}
        <a href="{{ url_for('ODES.get_extracts') }}">Your Custom Extracts</a> |
      {% endif %}
      <a href="https://mapzen.com/documentation/metro-extracts/">Documentation</a> | 
      <a href="https://mapzen.com/documentation/metro-extracts/walkthrough/">Tutorial</a> | 
      <a href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">File Format Guide</a>
    </div>
    
    {% if extract.odes.status == "pending" or extract.odes.status == "processing" %}
      <p class="error" style="margin-top:40px;">Sit tight! We will send you an email to the address associated with your GitHub account when your custom extract is ready for download.</p>
      <p class="error">Custom extracts take about 30-60 minutes to generate, depending on the size. The download links for your extract will appear on this page once it is ready.</p>
    {% elif extract.odes.links
        and 'osm2pgsql shapefiles zip' in extract.odes.links
        and 'osm2pgsql geojson zip' in extract.odes.links
        and 'imposm shapefiles zip' in extract.odes.links
        and 'imposm geojson zip' in extract.odes.links
        and 'osm pbf' in extract.odes.links
        and 'osm bz2' in extract.odes.links
        and 'water coastline zip' in extract.odes.links
        and 'land coastline zip' in extract.odes.links %}
      {% if extract.wof.name and extract.wof.id %}
        <div id="encompassed" style="margin-top: 40px;">
          <p>To clip this extract to the <span class="legend-blue">{{extract.wof.name}} boundary</span>, use this outline:</p>
          <a class="link" href="{{ url_for('Metro-Extracts.wof_geojson', id=extract.wof.id)}}">{{extract.wof.name}}  GEOJSON</a>
        </div>
      {% endif %}
      <h3>Downloads</h3>
      <div id="downloads">
        <div class="label">Datasets split by geometry type: lines, points, or polygons (<a href="https://mapzen.com/documentation/metro-extracts/overview/#osm2pgsql-and-imposm" class="label">OSM2PGSQL</a>)</div>
        <div class="dl-group">
          <a class="link" href="{{ extract.odes.links['osm2pgsql shapefiles zip'] }}"  data-format="OSM2PGSQL SHP">SHAPEFILE</a>
          <a class="link" href="{{ extract.odes.links['osm2pgsql geojson zip'] }}" data-format="OSM2PGSQL GEOJSON">GEOJSON</a>
        </div>
        <div class="label">Datasets grouped into individual layers by OpenStreetMap tags (<a href="https://mapzen.com/documentation/metro-extracts/overview/#osm2pgsql-and-imposm" class="label">IMPOSM</a>)</div>
        <div class="dl-group">
          <a class="link" href="{{ extract.odes.links['imposm shapefiles zip'] }}" data-format="IMPOSM SHP">SHAPEFILE</a>
          <a class="link" href="{{ extract.odes.links['imposm geojson zip'] }}" data-format="IMPOSM GEOJSON">GEOJSON</a>
        </div>
        <div class="label">Raw OpenStreetMap datasets (<a href="https://mapzen.com/documentation/metro-extracts/overview/#osm-pbf-and-osm-xml" class="label">PBF and XML</a>)</div>
        <div class="dl-group">
          <a class="link" href="{{ extract.odes.links['osm pbf'] }}" data-format="OSM PBF">OSM PBF</a>
          <a class="link" href="{{ extract.odes.links['osm bz2'] }}" data-format="OSM XML">OSM XML</a>
        </div>
        <div class="label">Coastlines</div>
        <div class="dl-group">
          <a class="link" href="{{ extract.odes.links['water coastline zip'] }}" data-format="WATER COASTLINE SHP">WATER SHAPEFILE</a>
          <a class="link" href="{{ extract.odes.links['land coastline zip'] }}" data-format="LAND COASTLINE SHP">LAND SHAPEFILE</a>
        </div>
        <p>If you're unsure of which file to pick, check out our <a href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">format guide</a>.</p>
      </div>
    {% else %}
      <p class="error" style="margin-top:40px;">Oh no, your extract request seems to have errored out. Please let us know at <a href="mailto:hello@mapzen.com">hello@mapzen.com</a>.</p>
    {% endif %}
  </div>
{% endblock %}

{% block js %}
  <script src='{{ url_for('static', filename='js/extract.js') }}'></script>
{% endblock %}

{% block script %}
  var mapHeight = window.innerWidth < 768 ? 300 : Math.max(window.innerHeight - 114, 500);
  d3.select("#map").style("height", mapHeight + 'px');

  var extractPage = Extract().init(
    {{ extract.odes.bbox|safe }}, 
    "{{ url_for('static', filename='scene.yaml') }}"
  );

  {% if extract.wof.name and extract.wof.id %}
    extractPage.showOutline("{{ url_for('Metro-Extracts.wof_geojson', id=extract.wof.id) }}");
  {% endif %}

  d3.selectAll(".link").on("click", function () {
    var name = "{{extract.wof.name or extract.id or extract.odes.id}}",
      format = d3.select(this).attr("data-format");
    ga('send', 'event', 'metroextracts', name, format);
  });
  
{% endblock %}